<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Campo Minado â€” ScalForce (tema ScalForce)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#140a1a;
    --card:#2b1943;
    --card-2:#1a0f2a;
    --accent:#ff8a00;
    --accent-700:#cc6d00;
    --muted:#cfc6d9;
    --panel:#170c25;
    --tile-bg:#eef1f3;
    --tile-border:#bfc9d6;
    --digit-bg:#1b0d27;
    --digit-red:#ff6b6b;
    --success:#36c38d;
  }

  *{box-sizing:border-box}
  html,body{height:100%; margin:0; font-family:Poppins, "Segoe UI", Arial, sans-serif; background:linear-gradient(180deg,#1a0f26 100%, #140a1a 100%); color:var(--muted)}
  a{color:inherit}

  .container{width:min(1100px,94%); margin:18px auto;}

:root{ --header-h:64px; }
header{ position:fixed; top:0; left:0; right:0; height:var(--header-h); z-index:9999; display:block; backdrop-filter:saturate(140%) blur(8px); background:linear-gradient(180deg, rgba(20,10,26,.9), rgba(20,10,26,.6) 80%, rgba(20,10,26,0)); }
header .container{ margin:0 auto; padding:0 14px; height:100%; display:flex; align-items:center; justify-content:space-between; }
main.container{ margin-top: calc(var(--header-h) + 8px); }

  .brand{display:flex;align-items:center; gap:.8rem}
 .brand img{height:48px; width:auto; display:block; filter:drop-shadow(0 2px 10px rgba(255,138,0,.2))}
  .brand span{color:var(--accent);font-weight:800}

  .layout{display:grid; grid-template-columns:1fr 320px 320px; gap:14px; margin-top:18px}
  @media (max-width:980px){ .layout{grid-template-columns:1fr} }

  .game-card{ background: linear-gradient(145deg, var(--card), var(--card-2)); border-radius:12px; padding:14px; border:3px solid rgba(255,255,255,.04); box-shadow:0 20px 50px rgba(0,0,0,.35); }
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .controls{display:flex;gap:.5rem;align-items:center}
  .btn{padding:.5rem .8rem;border-radius:8px;border:1px solid rgba(255,255,255,.04);background:transparent;color:var(--muted);cursor:pointer;font-weight:700}
    .btn.primary{ padding: 10px 17px; border-radius: 999px; border: none; background: #ff8a00; color: #1e1130; font-size: 1rem; font-weight: 600; cursor: pointer; box-shadow: 0 0 10px rgba(0,0,0,0.3); transition: background 0.3s, transform 0.2s;}
    .btn.primary:hover{background:var(--accent-700)}

  .toolbar{ display:flex; justify-content:center; align-items:center; gap:10px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.04); box-shadow: inset 0 2px 0 rgba(255,255,255,.02), 0 10px 25px rgba(0,0,0,.35); margin-bottom:12px; }

  .digits{ width:88px; height:36px; background:var(--digit-bg); color:var(--digit-red); font-family:monospace; font-weight:900; font-size:22px; display:flex; justify-content:center; align-items:center; border-radius:8px; box-shadow:0 3px 0 rgba(0,0,0,.4) inset; }

  .face-btn{ width:46px;height:46px;border-radius:10px;background:linear-gradient(180deg,#ffffff08,#ffffff03); border:2px solid rgba(255,255,255,.03); display:grid; place-items:center; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,.45); font-size:22px; color:var(--muted); }

  .field-wrap{ display:flex; justify-content:center; align-items:center; padding:12px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); border-radius:12px; border:1px solid rgba(255,255,255,.03); }

  .board { display:grid; gap:10px; background:transparent; padding:12px; border-radius:8px; }

  .tile { width:44px; height:44px; background: linear-gradient(180deg, var(--tile-bg), #e6eaee); border-radius:8px; border:1px solid var(--tile-border); box-shadow: 0 8px 0 rgba(0,0,0,0.12), 0 -2px 0 rgba(255,255,255,0.6) inset; display:grid; place-items:center; font-weight:800; font-size:20px; cursor:pointer; user-select:none; position:relative; color:#0b1220; }
  .tile.small { width:34px; height:34px; font-size:16px; border-radius:6px; }
  .tile.revealed { background: linear-gradient(180deg,#ff8a00,#ff9e30); box-shadow: inset 0 3px 0 #ff8a00; border:1px solid rgba(0,0,0,0.06); cursor:default; }
  .tile.flagged::after,
.cell.flagged::after { content: "ðŸš©"; position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; line-height: 1; transform: none; background: transparent; box-shadow: none; pointer-events: none; }
  .tile.mine::after{ content:''; position:absolute; width:46%; height:46%; background:radial-gradient(circle at 35% 30%, #6b6f73, #2f3336); border-radius:50%; box-shadow: 0 3px 8px rgba(0,0,0,0.4); }

  .num.n1{ color:#2aa05f; }
  .num.n2{ color:#1e7be6; }
  .num.n3{ color:#e44b3a; }
  .num.n4{ color:#6b3be4; }
  .num.n5{ color:#a0302a; }
  .num.n6{ color:#1d8a8a; }
  .num.n7{ color:#333; }
  .num.n8{ color:#111; }

  /* seleÃ§Ã£o (gamepad) â€” contorno laranja conforme pedido */
  .tile.selected { outline: 3px solid var(--accent); box-shadow: 0 8px 0 rgba(0,0,0,0.12), 0 0 18px rgba(255,138,0,0.12); transform: translateY(-2px); }

  .panel{background:linear-gradient(145deg,var(--panel),#0f0715);border-radius:12px;padding:14px;border:3px solid rgba(255,255,255,.04);color:var(--muted)}
  .panel h3{margin:0 0 8px 0;color:var(--accent)}
  .stat{display:flex;justify-content:space-between;padding:.5rem;border-radius:10px;background:linear-gradient(180deg,#110819,#12071a);border:1px solid rgba(255,255,255,.03);margin-bottom:.5rem}
  .stat strong{color:var(--accent)}
  .muted-light{color:var(--muted);font-size:.95rem}
  .explain{margin-top:8px;padding:.6rem;background:linear-gradient(180deg,#0f0715,#12071a);border-radius:8px;border:1px solid rgba(255,255,255,.03);min-height:64px;color:var(--muted)}

  @media (max-width:720px){ .tile{width:34px;height:34px;font-size:16px} .digits{width:72px;height:32px;font-size:20px} .face-btn{width:40px;height:40px;font-size:20px} }

.tile.small.flagged::after, .cell.small.flagged::after { font-size: 1rem; }
.tile.revealed.flagged::after, .cell.revealed.flagged::after { display: none; }

#preset { background: var(--accent); color: #1b0d27; border: 1px solid var(--accent-700); padding: 0.5rem 0.75rem; border-radius: 10px; font-weight: 700; cursor: pointer; appearance: none; }
#preset option { color: #1b0d27; background: linear-gradient(180deg, white, #f2f2f2); }
#preset:focus { outline: 3px solid rgba(255,138,0,0.18); outline-offset: 2px; }

/* level selector custom (gamepad-friendly) */
#levelSelector{ position:absolute; left:18px; top:88px; background:linear-gradient(180deg,#2b1943,#1a0f2a); border:2px solid rgba(255,255,255,0.04); padding:8px; border-radius:10px; display:none; z-index:9999 }
#levelSelector .opt{ padding:.6rem 1rem; margin:6px 0; border-radius:8px; background:transparent; color:var(--muted); cursor:pointer; border:1px solid rgba(255,255,255,0.03); }
#levelSelector .opt.highlight{ outline:3px solid var(--accent); background:linear-gradient(180deg, rgba(255,138,0,0.05), rgba(255,138,0,0.02)); color:#fff }

</style>
</head>
<body>
  <header>
    <div class="container" style="display:flex;justify-content:space-between;align-items:center;padding:0">
      <div class="brand">
        <img src="Logo.png" alt="ScalForce">
        <span>ScalForce</span>
      </div>
      <div>
        <a style="text-decoration: none;" class="btn primary" href="../ScalForce.html" id="backLink">Voltar</a>
      </div>
    </div>
  </header>
  <br>
  <br>
  <br>

  <main class="container" style="margin-top:18px">
    <div class="layout">
      <section class="game-card" aria-labelledby="gameTitle">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="position:relative">
            <select id="preset" class="btn" title="NÃ­vel" style="background:transparent;border:1px solid rgba(255,255,255,.04);color:var(--muted)">
              <option value="beginner">Iniciante (8Ã—8 â€¢ 10)</option>
              <option value="intermediate" selected>IntermediÃ¡rio (10Ã—10 â€¢ 20)</option>
              <option value="advanced">AvanÃ§ado (16Ã—16 â€¢ 40)</option>
              <option value="custom">Custom</option>
            </select>
            <div id="levelSelector" aria-hidden="true">
              <div class="opt" data-val="beginner">Iniciante (8Ã—8 â€¢ 10)</div>
              <div class="opt" data-val="intermediate">IntermediÃ¡rio (10Ã—10 â€¢ 20)</div>
              <div class="opt" data-val="advanced">AvanÃ§ado (16Ã—16 â€¢ 40)</div>
              <div class="opt" data-val="custom">Custom</div>
            </div>
            <span id="customInputs" style="display:none;margin-left:8px">
              <input id="rowsIn" type="number" min="5" value="10" style="width:64px;padding:.4rem;border-radius:6px;border:1px solid rgba(255,255,255,.04);background:transparent;color:var(--muted)">
              <input id="colsIn" type="number" min="5" value="10" style="width:64px;padding:.4rem;border-radius:6px;border:1px solid rgba(255,255,255,.04);background:transparent;color:var(--muted)">
              <input id="minesIn" type="number" min="1" value="20" style="width:84px;padding:.4rem;border-radius:6px;border:1px solid rgba(255,255,255,.04);background:transparent;color:var(--muted)">
            </span>
          </div>

          <div class="controls">
            <button id="newBtn" class="btn">Novo Jogo</button>
            <button id="revealBtn" class="btn">Revelar Tudo</button>
            <button id="hintBtn" class="btn">Dica</button>
          </div>
        </div>

        <div class="toolbar">
          <div class="digits" id="minesLeft">--</div>
          <div class="face-btn" id="faceBtn">ðŸ™‚</div>
          <div class="digits" id="timer">00:00</div>
        </div>

        <div class="field-wrap" style="margin-top:12px">
          <div id="board" class="board" role="application" aria-label="Tabuleiro"></div>
        </div>

        <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center; color:var(--muted)">
          <div>Clique esquerdo: revelar -- Clique direito: marcar bandeira</div>
          <div id="firstNote">Primeiro clique sempre seguro</div>
        </div>
      </section>

      <aside class="panel" aria-label="Painel lateral">
        <h3>Painel</h3>
        <div class="stat"><span>Minas restantes</span><strong id="minesLeftPanel">--</strong></div>
        <div class="stat"><span>Movimentos</span><strong id="moves">0</strong></div>
        <div class="stat"><span>Tempo</span><strong id="timerPanel">00:00</strong></div>

        <div style="margin-top:8px">
          <div style="font-weight:700;color:var(--muted)">Regras</div>
          <div style="margin-top:6px;color:var(--muted);line-height:1.35">
            â€¢ Primeiro clique sempre seguro.<br>
            â€¢ Clique esquerdo: revela cÃ©lula.<br>
            â€¢ Toque longo esquerdo: marca<br>
            â€¢ Clique direito: marca/desmarca bandeira.<br>
            â€¢ Revele todas as cÃ©lulas sem mina para vencer.
          </div>
        </div>

        <div class="explain" id="explain">Clique em uma cÃ©lula para ver explicaÃ§Ã£o.</div>

        <div style="margin-top:10px; display:flex; gap:6px">
          <button id="revealSafeBtn" class="btn" style="flex:1">Revelar Segura</button>
          <button id="resetBtn" class="btn" style="flex:1">Reiniciar</button>
        </div>

        <div style="margin-top:12px; font-size:.95rem; color:var(--muted)">Status: <span id="statusText">Aguardando</span></div>
        <div style="margin-top:8px; font-size:.95rem; color:var(--muted)">Gamepad: <strong id="gamepadStatus">Desconectado</strong></div>
      </aside>
      <aside class="panel" aria-label="Comandos do Controle">
  <h3>Comandos</h3>
  <ul style="margin:0; padding-left:18px; line-height:1.5; color:var(--muted)">
    <li>A â†’ Revelar cÃ©lula</li>
    <li>B â†’ Abrir/confirmar seletor de nÃ­vel</li>
    <li>X â†’ Revelar todas</li>
    <li>Y â†’ Dica</li>
    <li>LB â†’ Revelar cÃ©lula</li>
    <li>RB â†’ Marcar/desmarcar bandeira</li>
    <li>Start â†’ Novo jogo</li>
    <li>Back â†’ Revelar segura</li>
    <li>Direcionais / AnalÃ³gico â†’ Mover seleÃ§Ã£o</li>
    <li>AnalÃ³gico Direito â†’ Scroll no tabuleiro</li>
  </ul>
</aside>

    </div>
  </main>

<script>
(() => {
  const boardEl = document.getElementById('board');
  const minesLeftEl = document.getElementById('minesLeft');
  const minesLeftPanel = document.getElementById('minesLeftPanel');
  const timerDisplay = document.getElementById('timer');
  const timerPanel = document.getElementById('timerPanel');
  const movesEl = document.getElementById('moves');
  const explainEl = document.getElementById('explain');
  const statusEl = document.getElementById('statusText');
  const faceBtn = document.getElementById('faceBtn');
  const backLink = document.getElementById('backLink');
  const gamepadStatusEl = document.getElementById('gamepadStatus');

  const preset = document.getElementById('preset');
  const customInputs = document.getElementById('customInputs');
  const rowsIn = document.getElementById('rowsIn');
  const colsIn = document.getElementById('colsIn');
  const minesIn = document.getElementById('minesIn');
  const levelSelector = document.getElementById('levelSelector');
  const levelOptions = Array.from(levelSelector.querySelectorAll('.opt'));

  const newBtn = document.getElementById('newBtn');
  const revealBtn = document.getElementById('revealBtn');
  const resetBtn = document.getElementById('resetBtn');
  const hintBtn = document.getElementById('hintBtn');
  const revealSafeBtn = document.getElementById('revealSafeBtn');

  let rows=10, cols=10, mines=20;
  let board=[];
  let revealedCount=0, flagsCount=0, moves=0;
  let timerInterval=null, seconds=0;
  let gameOver=false, firstClickDone=false;

  // seleÃ§Ã£o controlada por gamepad
  let selR = 0, selC = 0;
  let gamepadConnected = false;

  // level selector state
  let selectorOpen = false;
  let selectorIndex = 1; // default intermediate

  function formatTime(s){ const m=Math.floor(s/60).toString().padStart(2,'0'); const ss=(s%60).toString().padStart(2,'0'); return m+':'+ss; }
  function setStatus(text){ statusEl.textContent = text; }

  function createEmptyBoard(r,c){
    const b = new Array(r);
    for(let i=0;i<r;i++){
      b[i] = new Array(c);
      for(let j=0;j<c;j++){
        b[i][j] = { mine:false, num:0, revealed:false, flagged:false, el:null, r:i, c:j };
      }
    }
    return b;
  }

  function placeMinesAvoiding(excludeR, excludeC){
    const positions=[];
    for(let i=0;i<rows;i++) for(let j=0;j<cols;j++){
      if(i===excludeR && j===excludeC) continue;
      positions.push({i,j});
    }
    for(let k=positions.length-1;k>0;k--){
      const t = Math.floor(Math.random()*(k+1));
      [positions[k],positions[t]] = [positions[t],positions[k]];
    }
    for(let p=0;p<mines;p++){
      const pos = positions[p];
      board[pos.i][pos.j].mine = true;
    }
    for(let i=0;i<rows;i++){
      for(let j=0;j<cols;j++){
        if(board[i][j].mine){ board[i][j].num = -1; continue; }
        let cnt=0;
        for(let di=-1;di<=1;di++) for(let dj=-1;dj<=1;dj++){
          if(di===0 && dj===0) continue;
          const ni=i+di, nj=j+dj;
          if(ni>=0 && ni<rows && nj>=0 && nj<cols && board[ni][nj].mine) cnt++;
        }
        board[i][j].num = cnt;
      }
    }
  }

  function buildBoard(){
    boardEl.innerHTML='';
    boardEl.style.gridTemplateColumns = `repeat(${cols}, ${tileSize()}px)`;
    boardEl.style.gridTemplateRows = `repeat(${rows}, ${tileSize()}px)`;
    for(let i=0;i<rows;i++){
      for(let j=0;j<cols;j++){
        const btn = document.createElement('button');
        btn.className = 'tile';
        if(tileSize() < 40) btn.classList.add('small');
        btn.type = 'button';
        btn.setAttribute('data-r', i);
        btn.setAttribute('data-c', j);
        btn.addEventListener('click', onLeftClick);
        btn.addEventListener('contextmenu', onRightClick);
        addLongPress(btn, ()=> toggleFlag(i,j));
        boardEl.appendChild(btn);
        board[i][j].el = btn;
      }
    }
    selR = 0; selC = 0;
    updateSelection();
  }

  function tileSize(){ if(cols <= 10) return 44; if(cols <= 14) return 36; return Math.max(18, Math.floor(440/cols)); }

  function startTimer(){ if(timerInterval) clearInterval(timerInterval); timerInterval = setInterval(()=>{ seconds++; timerDisplay.textContent = formatTime(seconds); timerPanel.textContent = formatTime(seconds); }, 1000); }
  function stopTimer(){ if(timerInterval) clearInterval(timerInterval); timerInterval=null; }

  function revealCell(r,c){
    const cell = board[r][c];
    if(cell.revealed || cell.flagged || gameOver) return;
    if(!firstClickDone){
      placeMinesAvoiding(r,c);
      firstClickDone = true;
      startTimer();
    }
    cell.revealed = true;
    revealedCount++;
    moves++; movesEl.textContent = moves;
    const el = cell.el;
    el.classList.add('revealed');
    el.disabled = true;

    if(cell.mine){
      el.classList.add('mine');
      el.innerHTML = 'ðŸ’£';
      loseGame(r,c);
      return;
    } else if(cell.num > 0){
      const sp = document.createElement('span');
      sp.className = `num n${Math.min(cell.num,8)}`;
      sp.textContent = cell.num;
      el.appendChild(sp);
      explainFor(cell);
    } else {
      explainFor(cell);
      flood(r,c);
    }
    checkWin();
  }

  function flood(sr, sc){
    const q = [{r:sr,c:sc}];
    while(q.length){
      const cur = q.shift();
      for(let di=-1; di<=1; di++) for(let dj=-1; dj<=1; dj++){
        const ni = cur.r + di, nj = cur.c + dj;
        if(ni<0||ni>=rows||nj<0||nj>=cols) continue;
        const nb = board[ni][nj];
        if(!nb.revealed && !nb.flagged && !nb.mine){
          nb.revealed = true;
          nb.el.classList.add('revealed');
          nb.el.disabled = true;
          revealedCount++;
          if(nb.num > 0){
            const sp = document.createElement('span');
            sp.className = `num n${Math.min(nb.num,8)}`;
            sp.textContent = nb.num;
            nb.el.appendChild(sp);
            explainFor(nb);
          } else {
            explainFor(nb);
            q.push({r:ni,c:nj});
          }
        }
      }
    }
  }

  function toggleFlag(r,c){
    if(gameOver) return;
    const o = board[r][c];
    if(o.revealed) return;
    o.flagged = !o.flagged;
    if(o.flagged){ o.el.classList.add('flagged'); flagsCount++; }
    else { o.el.classList.remove('flagged'); flagsCount = Math.max(0, flagsCount-1); }
    moves++; movesEl.textContent = moves;
    updateMinesLeft();
    checkWin();
  }

  function updateMinesLeft(){ const left = Math.max(0, mines - flagsCount); minesLeftEl.textContent = String(left).padStart(2,'0'); minesLeftPanel.textContent = String(left).padStart(2,'0'); }

  function checkWin(){ if(gameOver) return; const total = rows*cols; if(revealedCount === total - mines){ gameOver = true; setStatus('VitÃ³ria!'); faceBtn.textContent = 'ðŸ˜Ž'; stopTimer(); for(let i=0;i<rows;i++) for(let j=0;j<cols;j++){ const o = board[i][j]; if(o.mine && !o.flagged){ o.flagged = true; o.el.classList.add('flagged'); } } explainEl.textContent = 'ParabÃ©ns! VocÃª venceu.'; } }

  function loseGame(r,c){ gameOver = true; setStatus('Derrota'); faceBtn.textContent = 'ðŸ˜µ'; stopTimer(); for(let i=0;i<rows;i++) for(let j=0;j<cols;j++){ const o = board[i][j]; if(o.mine){ o.el.classList.add('revealed','mine'); o.el.disabled = true; if(!o.el.textContent) o.el.innerHTML = 'ðŸ’£'; } } explainEl.textContent = `VocÃª pisou em uma mina (${r+1}, ${c+1}).`; }

  function onLeftClick(e){ const el = e.currentTarget; const r = +el.getAttribute('data-r'), c = +el.getAttribute('data-c'); if(gameOver) return; const obj = board[r][c]; if(obj.flagged) return; revealCell(r,c); }
  function onRightClick(e){ e.preventDefault(); const el = e.currentTarget; const r = +el.getAttribute('data-r'), c = +el.getAttribute('data-c'); toggleFlag(r,c); }

  function hintReveal(){ if(gameOver) return; const cand = []; for(let i=0;i<rows;i++) for(let j=0;j<cols;j++){ const o = board[i][j]; if(!o.revealed && !o.mine && !o.flagged) cand.push(o); } if(!cand.length) return; const pick = cand[Math.floor(Math.random()*cand.length)]; revealCell(pick.r, pick.c); }

  function revealAll(){ for(let i=0;i<rows;i++) for(let j=0;j<cols;j++){ const o = board[i][j]; if(!o.revealed){ o.revealed = true; o.el.classList.add('revealed'); o.el.disabled = true; if(o.mine) { o.el.classList.add('mine'); o.el.innerHTML = 'ðŸ’£'; } else if(o.num>0){ const sp = document.createElement('span'); sp.className = `num n${Math.min(o.num,8)}`; sp.textContent = o.num; o.el.appendChild(sp); } } } stopTimer(); }

  function explainFor(cell){ if(cell.mine){ explainEl.textContent = 'ðŸ’£ Mina â€” revela mina e termina o jogo.'; return; } if(cell.num===0) explainEl.textContent = 'Sem minas ao redor â€” esta cÃ©lula Ã© segura.'; else explainEl.textContent = `NÃºmero ${cell.num} â€” existem ${cell.num} mina(s) nas vizinhas.`; }

  function resetGame(){
    const p = preset.value;
    if(p==='beginner'){ rows=8; cols=8; mines=10; }
    else if(p==='intermediate'){ rows=10; cols=10; mines=20; }
    else if(p==='advanced'){ rows=16; cols=16; mines=40; }
    else { const r = parseInt(rowsIn.value,10)||10; const c = parseInt(colsIn.value,10)||10; const m = parseInt(minesIn.value,10)||10; rows = Math.min(Math.max(5,r),40); cols = Math.min(Math.max(5,c),40); mines = Math.min(Math.max(1,m), rows*cols-1); }

    board = createEmptyBoard(rows,cols);
    revealedCount=0; flagsCount=0; moves=0; movesEl.textContent = 0;
    seconds=0; timerDisplay.textContent = '00:00'; timerPanel.textContent='00:00';
    stopTimer();
    gameOver=false; firstClickDone=false;
    faceBtn.textContent = 'ðŸ™‚';
    setStatus('Aguardando');
    explainEl.textContent = 'Clique em uma cÃ©lula para comeÃ§ar (primeiro clique seguro).';

    buildBoard();
    updateMinesLeft();
  }

  function addLongPress(el, callback, ms=550){ let timer=null; const start = (ev) => { if(timer) clearTimeout(timer); timer = setTimeout(()=> { callback(); timer=null; }, ms); }; const cancel = ()=> { if(timer){ clearTimeout(timer); timer=null; } }; el.addEventListener('touchstart', start, {passive:true}); el.addEventListener('touchend', cancel); el.addEventListener('touchmove', cancel); el.addEventListener('mousedown', (e)=>{ if(e.button!==0) return; start(); }); el.addEventListener('mouseup', cancel); el.addEventListener('mouseleave', cancel); }

  preset.addEventListener('change', ()=>{ if(preset.value==='custom') customInputs.style.display='inline-block'; else customInputs.style.display='none'; });
  newBtn.addEventListener('click', ()=> resetGame());
  resetBtn.addEventListener('click', ()=> resetGame());
  revealBtn.addEventListener('click', ()=> revealAll());
  hintBtn.addEventListener('click', ()=> hintReveal());
  revealSafeBtn.addEventListener('click', ()=> hintReveal());
  faceBtn.addEventListener('click', ()=> resetGame());

  resetGame();

  /* ----------- Gamepad API integration (atualizado) ----------- */
  // Mapping Xbox 360: A=0, B=1, X=2, Y=3, LB=4, RB=5, Back=8, Start=9
  let lastButtons = [];
  let lastAxes = [];
  let lastMoveTime = 0;
  const MOVE_COOLDOWN = 160; // ms entre movimentos do analÃ³gico/dpad (evita saltos)
  const AXIS_THRESHOLD = 0.45; // deadzone para eixos
  const RIGHT_AXIS_THRESHOLD = 0.2; // para scroll do analÃ³gico direito

  function updateSelection(){
    for(let i=0;i<rows;i++) for(let j=0;j<cols;j++){ board[i][j].el.classList.remove('selected'); }
    selR = Math.max(0, Math.min(rows-1, selR));
    selC = Math.max(0, Math.min(cols-1, selC));
    const el = board[selR][selC].el;
    if(el){ el.classList.add('selected'); el.scrollIntoView({block:'nearest', inline:'nearest'}); }
  }

  function moveSelection(dr, dc){ if(selectorOpen) return; selR += dr; selC += dc; if(selR < 0) selR = 0; if(selR > rows-1) selR = rows-1; if(selC < 0) selC = 0; if(selC > cols-1) selC = cols-1; updateSelection(); }

  function activateSelected(){ if(gameOver) return; const cell = board[selR][selC]; if(cell.flagged) return; revealCell(selR, selC); }
  function flagSelected(){ if(gameOver) return; toggleFlag(selR, selC); }
  function revealSelected(){ if(gameOver) return; revealCell(selR, selC); }

  // abrir/fechar level selector (B)
  function toggleLevelSelector(open){
    selectorOpen = (typeof open === 'boolean') ? open : !selectorOpen;
    levelSelector.style.display = selectorOpen ? 'block' : 'none';
    levelSelector.setAttribute('aria-hidden', (!selectorOpen).toString());
    if(selectorOpen){
      // setar index baseado no preset atual
      selectorIndex = ['beginner','intermediate','advanced','custom'].indexOf(preset.value);
      highlightLevel(selectorIndex);
    }
  }
  function highlightLevel(idx){ selectorIndex = Math.max(0, Math.min(levelOptions.length-1, idx)); levelOptions.forEach((o,i)=>{ o.classList.toggle('highlight', i===selectorIndex); }); }
  function selectLevelIndex(){ const val = levelOptions[selectorIndex].getAttribute('data-val'); preset.value = val; preset.dispatchEvent(new Event('change')); toggleLevelSelector(false); resetGame(); }

  function navigateSelector(dir){ // dir: -1 left/up, +1 right/down
    highlightLevel(selectorIndex + dir);
  }

  // Back (pressionar botÃ£o fÃ­sico B num Xbox Ã© botÃ£o Ã­ndice 1) â€” mas usuÃ¡rio pediu B para abrir seletor
  function pressBack(){ toggleLevelSelector(); }

  // Start cria novo jogo
  function pressStart(){ resetGame(); }

  window.addEventListener("gamepadconnected", (e) => {
    gamepadConnected = true;
    gamepadStatusEl.textContent = (e.gamepad && e.gamepad.id) ? e.gamepad.id.split(' (')[0] : 'Conectado';
    lastButtons = [];
    lastAxes = [];
    updateSelection();
  });
  window.addEventListener("gamepaddisconnected", (e) => {
    gamepadConnected = false;
    gamepadStatusEl.textContent = 'Desconectado';
    try { for(let i=0;i<rows;i++) for(let j=0;j<cols;j++) board[i][j].el.classList.remove('selected'); } catch(e){}
  });

  function pollGamepad(){
    const gps = navigator.getGamepads ? navigator.getGamepads() : [];
    if(!gps) return;
    const gp = gps[0];
    if(!gp) return;

    const now = performance.now();

    // left stick
    const ax0 = gp.axes[0] || 0; // left X
    const ax1 = gp.axes[1] || 0; // left Y
    // right stick
    const ax2 = gp.axes[2] || 0; // right X
    const ax3 = gp.axes[3] || 0; // right Y

    const dpadUp = gp.buttons[12] && gp.buttons[12].pressed;
    const dpadDown = gp.buttons[13] && gp.buttons[13].pressed;
    const dpadLeft = gp.buttons[14] && gp.buttons[14].pressed;
    const dpadRight = gp.buttons[15] && gp.buttons[15].pressed;

    let moved = false;
    if(now - lastMoveTime > MOVE_COOLDOWN){
      if(selectorOpen){
        // navegar no level selector com setas ou analÃ³gico esquerdo
        if(dpadLeft || ax0 < -AXIS_THRESHOLD){ navigateSelector(-1); moved = true; }
        else if(dpadRight || ax0 > AXIS_THRESHOLD){ navigateSelector(1); moved = true; }
        else if(dpadUp || ax1 < -AXIS_THRESHOLD){ navigateSelector(-1); moved = true; }
        else if(dpadDown || ax1 > AXIS_THRESHOLD){ navigateSelector(1); moved = true; }
      } else {
        if(dpadUp){ moveSelection(-1, 0); moved = true; }
        else if(dpadDown){ moveSelection(1, 0); moved = true; }
        else if(dpadLeft){ moveSelection(0, -1); moved = true; }
        else if(dpadRight){ moveSelection(0, 1); moved = true; }
        else {
          if(ax1 < -AXIS_THRESHOLD){ moveSelection(-1, 0); moved = true; }
          else if(ax1 > AXIS_THRESHOLD){ moveSelection(1, 0); moved = true; }
          else if(ax0 < -AXIS_THRESHOLD){ moveSelection(0, -1); moved = true; }
          else if(ax0 > AXIS_THRESHOLD){ moveSelection(0, 1); moved = true; }
        }
      }
      if(moved) lastMoveTime = now;
    }

       // right stick -> scroll do mouse / container
    if (Math.abs(ax2) > 0.1 || Math.abs(ax3) > 0.1) {
      try {
        boardEl.scrollBy({
          left: Math.round(ax2 * 25), // velocidade horizontal
          top: Math.round(ax3 * 25),  // velocidade vertical
          behavior: "smooth"
        });
      } catch (e) {

      }
    }


    // detecÃ§Ã£o de transiÃ§Ãµes de botÃµes
    gp.buttons.forEach((b, idx) => {
      const pressed = !!b.pressed;
      const wasPressed = !!(lastButtons[idx]);
      if(pressed && !wasPressed){
        switch(idx){
          case 0: // A -> ativar (revelar) cÃ©lula
            activateSelected();
            break;
          case 1: // B -> abrir/selecionar nÃ­vel (1Âº abre, 2Âº confirma)
            if(!selectorOpen) toggleLevelSelector(true);
            else selectLevelIndex();
            break;
          case 2: // X -> Revelar tudo
            revealAll();
            break;
          case 3: // Y -> dica
            hintReveal();
            break;
          case 4: // LB -> revelar cÃ©lula (atalho)
            revealSelected();
            break;
          case 5: // RB -> marcar/desmarcar bandeira
            flagSelected();
            break;
          case 9: // Start -> novo jogo
            pressStart();
            break;
          case 8: // Back (botÃ£o Select) -> revelar segura (mapeado)
            hintReveal();
            break;
        }
      }
      lastButtons[idx] = pressed;
    });

    if(!gamepadConnected){ gamepadConnected = true; gamepadStatusEl.textContent = gp.id ? gp.id.split(' (')[0] : 'Conectado'; }
  }

  function gamepadLoop(){ pollGamepad(); requestAnimationFrame(gamepadLoop); }
  requestAnimationFrame(gamepadLoop);

  // interactions for level selector (mouse/click support)
  levelOptions.forEach((opt, i)=>{
    opt.addEventListener('click', ()=>{ highlightLevel(i); selectLevelIndex(); });
  });

})();
</script>
</body>
</html>
